<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SHOJIN 運行管理 v3.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; font-size: 10px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; background: white; }
        table { border-collapse: collapse; width: 100%; border: 1.5px solid black; background: white; }
        th, td { border: 1px solid black; padding: 2px; text-align: center; }
        .day-on { background: #2563eb !important; color: white !important; }
        input, select { width: 100%; border: none; font-size: 11px; background: transparent; text-align: center; outline: none; }
        @media print { 
            .no-print { display: none !important; } 
            .max-w-5xl { width: 100% !important; border:none; margin:0; padding:0; }
            body { background: white; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<script type="module">
    const KEY = 'SHOJIN_DATA_V35_STAFF_PHONE';
    
    const loadState = () => {
        try {
            const saved = localStorage.getItem(KEY);
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return { cur: 'off1', off1: { 
            u:[], v:[], s:[], r:{}, 
            phones: [
                {id: "pA", label: "A携帯", num: "080-5989-3626", holder: ""},
                {id: "pB", label: "B携帯", num: "080-5989-3627", holder: ""}
            ] 
        }};
    };

    window.state = loadState();

    window.save = () => {
        localStorage.setItem(KEY, JSON.stringify(window.state));
        window.render();
    };

    const getDay = () => ["日","月","火","水","木","金","土"][new Date(document.getElementById('dateInput').value).getDay()];

    window.handleCsv = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const text = ev.target.result.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const rows = []; let row = []; let field = ''; let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const next = text[i+1];
                if (inQuotes) { if (char === '"' && next === '"') { field += '"'; i++; } else if (char === '"') { inQuotes = false; } else { field += char; } }
                else { if (char === '"') { inQuotes = true; } else if (char === ',') { row.push(field); field = ''; } else if (char === '\n') { row.push(field); if (row.length > 1) rows.push(row); row = []; field = ''; } else { field += char; } }
            }
            const cur = window.state[window.state.cur];
            cur.u = rows.slice(1).filter(c => c[0]).map(c => {
                let name = c[0].trim().split('\n').pop();
                let grade = c[4]?.trim(); if (/^[1-6]$/.test(grade)) grade = "小" + grade;
                return { id: 'U'+Math.random().toString(36).substr(2,5), name, address: c[2]?.trim(), school: c[3]?.trim(), grade, days: c[1]||"月火水木金土", defPick: "10:00", defDrop: "16:00", self: false, fixedV: "" };
            });
            window.save();
        };
        reader.readAsText(file, 'Shift-JIS');
    };

    window.autoAssign = () => {
        const date = document.getElementById('dateInput').value;
        const cur = window.state[window.state.cur];
        const day = getDay();
        const vs = cur.v.filter(v => v.days.includes(day));
        const us = cur.u.filter(u => u.days.includes(day) && !u.self);
        if (!vs.length) return alert("車両を登録してください。");
        cur.r[date] = { "迎え": {}, "送り": {} };
        vs.forEach(v => { cur.r[date]["迎え"][v.name] = []; cur.r[date]["送り"][v.name] = []; });
        
        us.forEach((u, i) => {
            const vName = u.fixedV && vs.some(v => v.name === u.fixedV) ? u.fixedV : vs[i % vs.length].name;
            cur.r[date]["迎え"][vName].push({ time: u.defPick, name: u.name, info: u.school });
            cur.r[date]["送り"][vName].push({ time: u.defDrop, name: u.name, info: "" });
        });
        window.save();
    };

    // 時間や名前の個別修正用
    window.updCell = (type, vName, idx, field, val) => {
        const date = document.getElementById('dateInput').value;
        const cur = window.state[window.state.cur];
        if (!cur.r[date]) return;
        cur.r[date][type][vName][idx][field] = val;
        // 時間変更時は並び替え
        if (field === 'time') {
            cur.r[date][type][vName].sort((a, b) => (a.time || "99:99").localeCompare(b.time || "99:99"));
        }
        localStorage.setItem(KEY, JSON.stringify(window.state));
        window.render();
    };

    window.render = () => {
        const cur = window.state[window.state.cur];
        const date = document.getElementById('dateInput').value;
        const day = getDay();
        const vs_today = cur.v.filter(v => v.days.includes(day));
        const s_today = cur.s.filter(s => s.days.includes(day));

        // PDFベースのスタッフ体制表（誰がどの携帯を持つかを選択）
        document.getElementById('staffHeader').innerHTML = `
            <div class="flex gap-4 mb-2">
                <div class="flex-1">
                    <div class="bg-gray-800 text-white text-[8px] font-bold px-2 py-0.5">スタッフ体制 (出勤職員)</div>
                    <table>
                        <tr class="h-6 bg-gray-50">
                            ${Array(4).fill(0).map((_, i) => `
                                <td class="w-8 bg-gray-200 font-bold">${i+1}</td>
                                <td class="w-24 font-black">${s_today[i]?.name || ''}</td>
                            `).join('')}
                        </tr>
                    </table>
                </div>
                <div class="w-72">
                    <div class="bg-blue-800 text-white text-[8px] font-bold px-2 py-0.5">連絡先・携帯所持</div>
                    <table>
                        ${cur.phones.map((p, i) => `
                            <tr class="h-6">
                                <td class="w-12 bg-gray-100 font-bold">${p.label}</td>
                                <td class="w-24"><input type="text" value="${p.num}" onchange="window.state.off1.phones[${i}].num=this.value;window.save()"></td>
                                <td class="bg-yellow-50">
                                    <select onchange="window.state.off1.phones[${i}].holder=this.value;window.save()">
                                        <option value="">(持機者選択)</option>
                                        ${s_today.map(s => `<option value="${s.name}" ${p.holder===s.name?'selected':''}>${s.name}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            </div>
        `;

        ['迎え', '送り'].forEach(type => {
            document.getElementById(type + 'Area').innerHTML = vs_today.map(v => {
                // その車両の連絡先として、所持者名を表示
                const phoneInfo = cur.phones.map(p => p.holder ? `${p.holder}(${p.label})` : p.label).join(' / ');
                
                return `
                <div class="mb-3 border-2 border-black break-inside-avoid">
                    <table class="w-full bg-slate-100 text-[8px]">
                        <tr>
                            <td class="w-8 bg-black text-white">運転</td><td class="w-20 bg-white"><input type="text"></td>
                            <td class="w-8 bg-gray-600 text-white">添乗</td><td class="w-20 bg-white"><input type="text"></td>
                            <td class="w-8 bg-blue-800 text-white">車両</td><td class="font-black text-[10px] bg-white text-blue-900">${v.name}</td>
                            <td class="w-12 bg-orange-700 text-white">連絡先</td>
                            <td class="bg-white text-black text-left px-1 font-bold">${phoneInfo}</td>
                        </tr>
                    </table>
                    <table class="w-full border-t border-black">
                        <tr class="bg-gray-100 text-[7px] h-3"><td>時間</td><td>氏名</td><td>${type==='迎え'?'学校名':'備考'}</td></tr>
                        ${(cur.r[date]?.[type]?.[v.name] || Array(7).fill({time:'',name:'',info:''})).map((row, idx) => `
                            <tr class="h-7 border-t border-gray-300">
                                <td class="w-12 font-bold bg-yellow-50">
                                    <input type="text" value="${row.time||''}" onchange="window.updCell('${type}','${v.name}',${idx},'time',this.value)">
                                </td>
                                <td class="w-32 text-left px-1 font-black text-[12px]">
                                    <input type="text" value="${row.name||''}" onchange="window.updCell('${type}','${v.name}',${idx},'name',this.value)">
                                </td>
                                <td class="text-left px-1 text-[9px]">
                                    <input type="text" value="${row.info||''}" onchange="window.updCell('${type}','${v.name}',${idx},'info',this.value)">
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `}).join('');
            
            const self_today = cur.u.filter(u => u.days.includes(day) && u.self);
            document.getElementById(type + 'Self').innerHTML = self_today.length ? `
                <div class="p-1 border-2 border-double border-red-500 bg-red-50 mb-2">
                    <div class="text-[8px] font-bold text-red-600 underline">▼ 保護者送迎 (${type})</div>
                    <div class="flex flex-wrap gap-2 py-1">
                        ${self_today.map(u => `<span class="text-[11px] font-black">● ${u.name}</span>`).join('')}
                    </div>
                </div>
            ` : '';
        });

        document.getElementById('userTable').innerHTML = cur.u.map(u => `
            <tr class="h-8">
                <td><input type="text" value="${u.name}" class="font-bold"></td>
                <td><input type="text" value="${u.grade}" class="w-12"></td>
                <td><input type="text" value="${u.school}"></td>
                <td><select onchange="window.upd('u','${u.id}','fixedV',this.value)"><option value="">フリー</option>${cur.v.map(v=>`<option value="${v.name}" ${u.fixedV===v.name?'selected':''}>${v.name}</option>`).join('')}</select></td>
                <td><input type="checkbox" ${u.self?'checked':''} onchange="window.upd('u','${u.id}','self',this.checked)"></td>
                <td><button onclick="window.del('u','${u.id}')" class="text-red-500 font-bold">×</button></td>
            </tr>
        `).join('');

        document.getElementById('attendList').innerHTML = cur.u.filter(u => u.days.includes(day)).map(u => `
            <tr class="h-8 text-[9px] border-b">
                <td class="font-black text-left pl-1">${u.name}</td>
                <td>${u.grade}</td>
                <td class="text-left pl-1 text-red-600 font-bold"><input type="text"></td>
            </tr>
        `).join('');

        const drawC = (list, t) => list.map(i => `<div class="flex items-center justify-between p-2 border-b
