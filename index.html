<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>運行管理システム v49.1 - 機能維持・修正版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; font-size: 11px; color: #000; }
        table { border-collapse: collapse; width: 100%; border: 2px solid black; background: white; }
        th, td { border: 1px solid black; padding: 2px; text-align: center; }
        .label-cell { background: #f3f4f6; font-size: 10px; font-weight: bold; width: 45px; }
        .user-name-select { font-size: 15px !important; font-weight: 900 !important; color: #000; width: 100%; border: none; background: transparent; appearance: none; }
        .school-info { color: #1d4ed8; font-size: 11px; font-weight: bold; display: block; line-height: 1.2; }
        .time-input { background: #fffbeb !important; border: 1px solid #f59e0b !important; font-size: 15px !important; font-weight: bold; width: 100%; text-align: center; }
        .is-absent { background-color: #e5e7eb !important; color: #9ca3af !important; }
        .day-chip { cursor: pointer; padding: 0 4px; border-radius: 2px; font-size: 9px; border: 1px solid #ccc; }
        .day-active { background-color: #2563eb; color: white; border-color: #1e40af; }
        .day-inactive { background-color: #e5e7eb; color: #9ca3af; }
        @media print { 
            .no-print { display: none !important; } 
            .print-area { width: 100% !important; border: none !important; margin: 0 !important; padding: 0 !important; } 
            @page { size: A4; margin: 5mm; }
        }
    </style>
</head>
<body class="min-h-screen">

<script>
    const STORAGE_KEY = 'SHOJIN_V49_MASTER';
    const OFFICE_NAMES = ["星の村", "カラフル", "プリズム"];
    
    const toHalf = (s) => s ? String(s).replace(/[０-９]/g, a => String.fromCharCode(a.charCodeAt(0) - 0xFEE0)) : "";
    const abbrSchool = (s) => s ? s.replace(/小学校/g, "小").replace(/中学校/g, "中").replace(/支援学校/g, "支") : "";
    const formatGrade = (g) => {
        const val = toHalf(g);
        return /^[1-6]$/.test(val) ? "小" + val : val;
    };

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        curIdx: 0, offices: Array(3).fill(null).map(() => ({ u: [], v: [], s: [], r: {}, attendance: {}, phones: [{id:1, label:"A携帯", num:""}] }))
    };

    const save = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render(); };
    const getCur = () => state.offices[state.curIdx];
    const getDate = () => document.getElementById('dateInput').value;
    const getDay = () => ["日","月","火","水","木","金","土"][new Date(getDate()).getDay()];

    window.exportData = () => {
        const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `送迎データ全バックアップ_${new Date().toLocaleDateString()}.json`;
        a.click();
    };

    window.importData = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const imported = JSON.parse(ev.target.result);
                if(confirm('現在のデータがすべて上書きされますがよろしいですか？')) {
                    state = imported;
                    save();
                    alert('同期が完了しました');
                }
            } catch(err) { alert('ファイル形式が正しくありません'); }
        };
        reader.readAsText(file);
    };

    // 時間で並び替える関数
    const sortRoute = (members) => {
        return members.sort((a, b) => {
            if (!a.time) return 1;
            if (!b.time) return -1;
            return a.time.localeCompare(b.time);
        });
    };

    window.autoAssign = () => {
        const d = getDate(); const day = getDay(); const cur = getCur();
        const att = cur.attendance[d] || {};
        cur.r[d] = { "迎え": [], "送り": [] };
        const vList = cur.v.filter(v => v.days.includes(day));

        ["迎え", "送り"].forEach(type => {
            const typeProp = type === "迎え" ? "inType" : "outType";
            const timeProp = type === "迎え" ? "inTime" : "outTime";
            let remain = cur.u.filter(u => u.days.includes(day) && att[u.id] !== '欠' && u[typeProp] === '車両');
            
            cur.r[d][type] = vList.map(v => {
                const route = { vName: v.name, driver: "", staff: "", phoneNum: "", members: [] };
                const prefUsers = remain.filter(u => u.prefCar === v.name);
                prefUsers.forEach(u => {
                    if(route.members.length < 8) { route.members.push({ uId: u.id, time: u[timeProp] }); remain = remain.filter(x => x.id !== u.id); }
                });
                while(route.members.length < 8) {
                    const u = remain.shift();
                    route.members.push({ uId: u ? u.id : "", time: u ? u[timeProp] : "" });
                }
                route.members = sortRoute(route.members);
                return route;
            });
        });
        save();
    };

    window.render = () => {
        const cur = getCur(); const date = getDate(); const day = getDay();
        const att = cur.attendance[date] || {};
        document.getElementById('officeTitle').innerText = OFFICE_NAMES[state.curIdx];
        document.getElementById('printDate').innerText = date.replace(/-/g, '/') + ` (${day})`;

        ['迎え', '送り'].forEach(type => {
            const routes = cur.r[date]?.[type] || [];
            const area = document.getElementById(type + 'Area');
            area.innerHTML = routes.map((route, rIdx) => {
                route.members.forEach(m => { if(m.uId && att[m.uId] === '欠') { m.uId = ""; m.time = ""; } });
                return `
                <div class="mb-1 border-2 border-black relative">
                    <button class="no-print absolute top-0 right-1 text-red-500 font-bold px-1" onclick="getCur().r['${date}']['${type}'].splice(${rIdx},1);save()">×</button>
                    <table>
                        <tr class="bg-gray-100 font-bold text-[11px]"><td colspan="6" class="text-left px-2 italic">便名：<input type="text" class="bg-transparent" value="${route.vName}" onchange="getCur().r['${date}']['${type}'][${rIdx}].vName=this.value;save()"></td></tr>
                        <tr>
                            <td class="label-cell">運転</td>
                            <td class="w-24"><select class="w-full text-[11px] font-bold" onchange="getCur().r['${date}']['${type}'][${rIdx}].driver=this.value;save()"><option value="">--</option>${cur.s.filter(s=>s.days.includes(day)).map(s=>`<option value="${s.name}" ${route.driver===s.name?'selected':''}>${s.name}</option>`).join('')}</select></td>
                            ${[0, 1].map(i => renderCell(date, type, rIdx, i, route.members[i], cur, day, att)).join('')}
                        </tr>
                        <tr>
                            <td class="label-cell">添乗</td>
                            <td><select class="w-full text-[11px] font-bold" onchange="getCur().r['${date}']['${type}'][${rIdx}].staff=this.value;save()"><option value="">--</option>${cur.s.filter(s=>s.days.includes(day)).map(s=>`<option value="${s.name}" ${route.staff===s.name?'selected':''}>${s.name}</option>`).join('')}</select></td>
                            ${[2, 3].map(i => renderCell(date, type, rIdx, i, route.members[i], cur, day, att)).join('')}
                        </tr>
                        <tr>
                            <td class="label-cell">連絡先</td>
                            <td class="flex items-center">
                                <select class="no-print w-6 text-[8px]" onchange="getCur().r['${date}']['${type}'][${rIdx}].phoneNum=this.value;save()"><option value="">選</option>${cur.phones.map(p=>`<option value="${p.num}">${p.label}</option>`).join('')}</select>
                                <input type="text" class="w-full text-center text-[11px] font-bold" value="${route.phoneNum}" onchange="getCur().r['${date}']['${type}'][${rIdx}].phoneNum=this.value;save()">
                            </td>
                            ${[4, 5].map(i => renderCell(date, type, rIdx, i, route.members[i], cur, day, att)).join('')}
                        </tr>
                        <tr><td class="label-cell">備考</td><td></td>${[6, 7].map(i => renderCell(date, type, rIdx, i, route.members[i], cur, day, att)).join('')}</tr>
                    </table>
                </div>`;
            }).join('');
            
            const typeProp = type === "迎え" ? "inType" : "outType";
            const timeProp = type === "迎え" ? "inTime" : "outTime";
            const selfUsers = cur.u.filter(u => u.days.includes(day) && u[typeProp] !== '車両' && att[u.id] !== '欠');
            document.getElementById(type + 'Self').innerHTML = selfUsers.length ? `<span class="text-blue-700 font-bold">【自力・保護者】</span> ${selfUsers.map(u => u.name+'('+u[timeProp]+')').join(', ')}` : '';
        });

        const activeToday = cur.u.filter(u => u.days.includes(day));
        document.getElementById('attendList').innerHTML = activeToday.map((u, idx) => `
            <tr class="h-8 ${att[u.id]==='欠' ? 'is-absent' : ''}">
                <td class="text-[10px] w-6">${idx+1}</td>
                <td class="no-print"><button onclick="const d='${date}'; const c=getCur(); if(!c.attendance[d]) c.attendance[d]={}; c.attendance[d]['${u.id}']=c.attendance[d]['${u.id}']==='欠'?'出':'欠'; save();" class="border px-1 bg-white font-bold">${att[u.id]==='欠'?'欠':'出'}</button></td>
                <td class="w-24 font-bold text-[13px]">${u.name}</td>
                <td class="text-[10px] w-24">${abbrSchool(u.school)} / ${formatGrade(u.grade)}</td>
                <td class="px-1"><input type="text" class="w-full bg-transparent font-bold text-
