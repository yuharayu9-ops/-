<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>SHOJIN 運行管理 v2.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f1f5f9; font-size: 10px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; background: white; }
        table { border-collapse: collapse; width: 100%; border: 1.5px solid black; background: white; }
        th, td { border: 1px solid black; padding: 2px; text-align: center; }
        .day-on { background: #2563eb !important; color: white !important; }
        input { width: 100%; border: none; font-size: 11px; background: transparent; text-align: center; outline: none; }
        .input-memo { border-bottom: 1px dashed #ccc !important; text-align: left; padding-left: 4px; }
        @media print { 
            .no-print { display: none !important; } 
            .max-w-5xl { width: 100%; max-width: none; border:none; margin:0; padding:0; }
            body { background: white; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<script type="module">
    const KEY = 'SHOJIN_DATA_V29_FINAL';
    
    // データの読み込み
    const loadState = () => {
        try {
            const saved = localStorage.getItem(KEY);
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        return { cur: 'off1', off1: { u:[], v:[], s:[], r:{}, phones:["080-xxxx-xxxx", "090-xxxx-xxxx"] } };
    };

    window.state = loadState();

    window.save = () => {
        localStorage.setItem(KEY, JSON.stringify(window.state));
        window.render();
    };

    const getDay = () => ["日","月","火","水","木","金","土"][new Date(document.getElementById('dateInput').value).getDay()];

    // CSV解析（ダブルクォーテーション内の改行を保護する高度なパース）
    function parseCSV(text) {
        const rows = [];
        let row = [];
        let field = '';
        let inQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const next = text[i+1];
            if (inQuotes) {
                if (char === '"' && next === '"') { field += '"'; i++; }
                else if (char === '"') { inQuotes = false; }
                else { field += char; }
            } else {
                if (char === '"') { inQuotes = true; }
                else if (char === ',') { row.push(field); field = ''; }
                else if (char === '\n' || char === '\r') {
                    row.push(field);
                    if (row.length > 0 && row[0] !== "") rows.push(row);
                    row = []; field = '';
                    if (char === '\r' && next === '\n') i++;
                } else { field += char; }
            }
        }
        if (field || row.length > 0) { row.push(field); rows.push(row); }
        return rows;
    }

    window.handleCsv = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const rows = parseCSV(ev.target.result);
            const cur = window.state[window.state.cur];
            cur.u = []; 
            rows.forEach((c, index) => {
                if (index === 0 || !c[0] || c[0].includes("利用者名")) return; 

                // 1. 名前抽出（ひらがなを除去して2行目の漢字を取得）
                let fullName = c[0].trim();
                let kanjiName = fullName;
                if (fullName.includes('\n')) {
                    const parts = fullName.split('\n');
                    kanjiName = (parts[1] || parts[0]).trim();
                } else if (fullName.includes('\r')) {
                    const parts = fullName.split('\r');
                    kanjiName = (parts[1] || parts[0]).trim();
                }

                // 2. 学年（小○に変換）
                let grade = (c[4] || "").trim();
                if (/^[1-6]$/.test(grade)) grade = "小" + grade;

                // 3. 曜日判定
                const group = c[1] || "";
                const days = ["月","火","水","木","金","土"].filter(d => group.includes(d)).join('');

                cur.u.push({
                    id: 'U' + Math.random().toString(36).substr(2, 5),
                    name: kanjiName,
                    address: (c[2] || "").trim(),
                    school: (c[3] || "").trim(),
                    grade: grade,
                    days: days || "月火水木金土",
                    defPick: "14:00",
                    defDrop: "17:00",
                    self: false,
                    memo: ""
                });
            });
            window.save();
            alert("CSVを正常に読み込みました。");
        };
        reader.readAsText(file, 'Shift-
